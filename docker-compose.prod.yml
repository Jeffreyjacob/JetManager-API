

services:
    migrate:
      image: ghcr.io/jeffreyjacob/jetmanager_api:main
      container_name: jetmanagerApi-migrate
      env_file:
      - .env
      command: ["npx", "prisma", "migrate", "deploy"]
      restart: "no"


    backend:
      image: ghcr.io/jeffreyjacob/jetmanager_api:main
      container_name: jetmanagerApi-backend
      restart: always
      env_file:
        - .env
      expose:
        - "8000"
      depends_on:
        - migrate
      command: ["node", "dist/server.js"]
      


    worker:
      image: ghcr.io/jeffreyjacob/jetmanager_api:main
      container_name: jetmanagerApi-worker
      restart: always
      env_file:
        - .env
      depends_on:
        - migrate
      command: ["node", "dist/worker.js"]

    caddy:
       image: caddy:2
       container_name: jetmanagerApi-candy
       restart: always
       depends_on:
          - backend
       ports:
         - "80:80"
         - "443:443"
       volumes:
         - ./Caddyfile:/etc/caddy/Caddyfile
         - caddy_data:/data
         - caddy_config:/config


volumes:
  caddy_data:
  caddy_config:


